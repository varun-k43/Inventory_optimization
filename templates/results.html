{% extends "base.html" %} {% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Inventory Forecast Results</h2>

  {% if not components %}
  <div class="alert alert-warning">
    No forecasts available. Please upload data first.
  </div>
  {% else %}
  <!-- Summary Cards -->
  <div class="row mb-4">
    {% for component in components %}
    <div class="col-md-4 mb-3">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">{{ component }}</h5>
        </div>
        <div class="card-body">
          {% set summary = forecast_summary.get(component, {}) %}
          <div class="d-flex justify-content-between mb-2">
            <span>Current Stock:</span>
            <span class="fw-bold">{{ current_stock.get(component, 0) }}</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Avg. Forecast:</span>
            <span class="fw-bold"
              >{{ "%.2f"|format(summary.get('avg_forecast', 0)) }}</span
            >
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Avg. Recommended Stock:</span>
            <span class="fw-bold"
              >{{ "%.0f"|format(summary.get('avg_recommended_stock', 0))
              }}</span
            >
          </div>
          <div class="d-flex justify-content-between">
            <span>Forecast Period:</span>
            <span>
              {{ summary.get('first_forecast_date', '') }} to {{
              summary.get('last_forecast_date', '') }}
            </span>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Tabs Navigation -->
  <ul class="nav nav-tabs" id="componentTabs" role="tablist">
    {% for component in components %}
    <li class="nav-item" role="presentation">
      <button
        class="nav-link {% if loop.first %}active{% endif %}"
        id="{{ component }}-tab"
        data-bs-toggle="tab"
        data-bs-target="#{{ component }}"
        type="button"
        role="tab"
        aria-controls="{{ component }}"
        aria-selected="{% if loop.first %}true{% else %}false{% endif %}"
      >
        {{ component }}
      </button>
    </li>
    {% endfor %}
  </ul>

  <!-- Tab Content -->
  <div
    class="tab-content p-3 border border-top-0 rounded-bottom"
    id="componentTabsContent"
  >
    {% for component, component_forecasts in forecasts.items() %}
    <div
      class="tab-pane fade {% if loop.first %}show active{% endif %}"
      id="{{ component }}"
      role="tabpanel"
      aria-labelledby="{{ component }}-tab"
    >
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>Forecast Data</h4>
            <div class="btn-group">
              <a
                href="{{ url_for('download_forecast', component=component, format='csv') }}"
                class="btn btn-sm btn-outline-primary"
              >
                <i class="bi bi-file-earmark-spreadsheet"></i> CSV
              </a>
              <a
                href="{{ url_for('download_forecast', component=component, format='xlsx') }}"
                class="btn btn-sm btn-outline-success"
              >
                <i class="bi bi-file-earmark-excel"></i> Excel
              </a>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Date</th>
                  <th>Forecast</th>
                  <th>Recommended Stock</th>
                </tr>
              </thead>
              <tbody>
                {% for forecast in component_forecasts %}
                <tr>
                  <td>{{ forecast.date }}</td>
                  <td>{{ "%.2f"|format(forecast.forecast) }}</td>
                  <td
                    class="{% if current_stock.get(component, 0) < forecast.recommended_stock %}table-warning{% endif %}"
                  >
                    {{ forecast.recommended_stock|int }} {% if
                    current_stock.get(component, 0) < forecast.recommended_stock
                    %}
                    <span class="badge bg-danger ms-2">Low Stock</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <div class="col-md-6">
          <h4>Forecast Visualization</h4>
          <div class="card">
            <div class="card-body text-center">
              <img
                src="{{ plot_paths[component] }}"
                alt="{{ component }} Forecast"
                class="img-fluid"
                style="max-height: 400px"
              />
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="mt-4">
    <a href="{{ url_for('index') }}" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Back to Upload
    </a>
  </div>
  {% endif %}
</div>
{% endblock %} {% block scripts %} {{ super() }}
<script>
  // Initialize tooltips
  var tooltipTriggerList = [].slice.call(
    document.querySelectorAll('[data-bs-toggle="tooltip"]')
  );
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  // Initialize popovers
  var popoverTriggerList = [].slice.call(
    document.querySelectorAll('[data-bs-toggle="popover"]')
  );
  var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
    return new bootstrap.Popover(popoverTriggerEl);
  });

  // Activate the first tab by default
  var firstTabEl = document.querySelector("#componentTabs .nav-link");
  if (firstTabEl) {
    var firstTab = new bootstrap.Tab(firstTabEl);
    firstTab.show();
  }
</script>
{% endblock %}
