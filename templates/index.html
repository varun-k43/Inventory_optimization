{% extends "base.html" %} {% block content %}
<div class="row justify-content-center">
  <div class="col-lg-10">
    <div class="card">
      <div class="card-header">
        <i class="fas fa-file-upload me-2"></i>Upload Your Data Files
      </div>
      <div class="card-body">
        <p class="text-muted mb-4">
          Please upload the following CSV files to analyze your inventory and
          generate demand forecasts. Ensure your files contain the required
          columns as specified in the documentation.
        </p>

        <form
          id="uploadForm"
          action="{{ url_for('upload') }}"
          method="post"
          enctype="multipart/form-data"
        >
          <!-- Inventory Timeseries File -->
          <div class="mb-4">
            <label for="inventory_file" class="form-label file-label">
              <i class="fas fa-boxes me-2"></i>Inventory Timeseries (CSV)
            </label>
            <div
              class="upload-area"
              onclick="document.getElementById('inventory_file').click()"
            >
              <i class="fas fa-file-csv fa-3x text-primary mb-2"></i>
              <p class="mb-1">Click to upload or drag and drop</p>
              <p class="file-info" id="inventory_file_info">No file selected</p>
              <input
                type="file"
                class="file-input"
                id="inventory_file"
                name="inventory_file"
                accept=".csv"
                required
              />
            </div>
            <div class="form-text">
              Required columns: <code>date</code>, <code>component_name</code>,
              <code>stock_level</code>
            </div>
          </div>

          <!-- Purchase Orders File -->
          <div class="mb-4">
            <label for="purchase_file" class="form-label file-label">
              <i class="fas fa-shopping-cart me-2"></i>Purchase Orders (CSV)
            </label>
            <div
              class="upload-area"
              onclick="document.getElementById('purchase_file').click()"
            >
              <i class="fas fa-file-csv fa-3x text-primary mb-2"></i>
              <p class="mb-1">Click to upload or drag and drop</p>
              <p class="file-info" id="purchase_file_info">No file selected</p>
              <input
                type="file"
                class="file-input"
                id="purchase_file"
                name="purchase_file"
                accept=".csv"
                required
              />
            </div>
            <div class="form-text">
              Required columns: <code>date</code>, <code>component_name</code>,
              <code>order_quantity</code>
            </div>
          </div>

          <!-- Starting Inventory File -->
          <div class="mb-4">
            <label for="starting_file" class="form-label file-label">
              <i class="fas fa-warehouse me-2"></i>Starting Inventory (CSV)
            </label>
            <div
              class="upload-area"
              onclick="document.getElementById('starting_file').click()"
            >
              <i class="fas fa-file-csv fa-3x text-primary mb-2"></i>
              <p class="mb-1">Click to upload or drag and drop</p>
              <p class="file-info" id="starting_file_info">No file selected</p>
              <input
                type="file"
                class="file-input"
                id="starting_file"
                name="starting_file"
                accept=".csv"
                required
              />
            </div>
            <div class="form-text">
              Required columns: <code>component_name</code>,
              <code>stock_level</code>
            </div>
          </div>

          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button type="submit" class="btn btn-primary btn-upload">
              <i class="fas fa-chart-line me-2"></i>Generate Forecast
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-header">
        <i class="fas fa-info-circle me-2"></i>About This Tool
      </div>
      <div class="card-body">
        <h5 class="card-title">Inventory Optimization & Demand Forecasting</h5>
        <p class="card-text">
          This tool helps you optimize your inventory by analyzing historical
          data and forecasting future demand for your electronic components. The
          system will:
        </p>
        <ul>
          <li>Analyze your inventory and order history</li>
          <li>Generate demand forecasts for the next 3 months</li>
          <li>Provide recommendations for inventory reorder points</li>
          <li>Visualize trends and forecast accuracy</li>
        </ul>
        <p class="card-text">
          <small class="text-muted">
            For best results, provide at least 6 months of historical data.
          </small>
        </p>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document
    .getElementById("uploadForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      // Show loading state
      const submitBtn = document.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML =
        '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';

      // Get the form element
      const form = e.target;
      const formData = new FormData(form);

      // Log form data for debugging
      for (let [key, value] of formData.entries()) {
        console.log(key, value);
      }

      // Submit the form using fetch
      fetch(form.action, {
        method: "POST",
        body: formData,
        headers: {
          // Let the browser set the Content-Type with the correct boundary
        },
        // Important: Don't set Content-Type header, let the browser set it with the correct boundary
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response;
        })
        .then((response) => {
          if (response.redirected) {
            window.location.href = response.url;
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
          alert("An error occurred while uploading files. Please try again.");
        });
    });

  // Update file info when files are selected
  document
    .getElementById("inventory_file")
    .addEventListener("change", function (e) {
      const fileName = e.target.files[0]
        ? e.target.files[0].name
        : "No file selected";
      document.getElementById("inventory_file_info").textContent = fileName;
    });

  document
    .getElementById("purchase_file")
    .addEventListener("change", function (e) {
      const fileName = e.target.files[0]
        ? e.target.files[0].name
        : "No file selected";
      document.getElementById("purchase_file_info").textContent = fileName;
    });

  document
    .getElementById("starting_file")
    .addEventListener("change", function (e) {
      const fileName = e.target.files[0]
        ? e.target.files[0].name
        : "No file selected";
      document.getElementById("starting_file_info").textContent = fileName;
    });

  // Handle drag and drop
  const uploadAreas = document.querySelectorAll(".upload-area");

  uploadAreas.forEach((area) => {
    ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
      area.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ["dragenter", "dragover"].forEach((eventName) => {
      area.addEventListener(eventName, highlight, false);
    });

    ["dragleave", "drop"].forEach((eventName) => {
      area.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
      area.classList.add("border-primary");
    }

    function unhighlight() {
      area.classList.remove("border-primary");
    }

    area.addEventListener("drop", handleDrop, false);
  });

  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    const input = this.querySelector('input[type="file"]');
    input.files = files;

    // Trigger change event to update file info
    const event = new Event("change");
    input.dispatchEvent(event);
  }
</script>
{% endblock %}
